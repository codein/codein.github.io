<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Robin Varghese | Single-threaded vs Multi-threading vs Multi-processing in Python</title>
  <meta property="og:title" content="Robin Varghese | Single-threaded vs Multi-threading vs Multi-processing in Python" />
  <meta property="og:image" content="http://codein.github.io/img/profilePic.png" />
  <meta name="description" content="Single-threaded vs Multi-threading vs Multi-processing in Python">
  <meta property="og:description" content="Single-threaded vs Multi-threading vs Multi-processing in Python" />
  <meta name="author" content="Robin Varghese">
  
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css"></noscript>
  
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900&display=swap"></noscript>
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap"></noscript>
  <link rel="preload" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.min.css"></noscript>
  
  <link rel="preload" href="http://codein.github.io/css/resume.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://codein.github.io/css/resume.css"></noscript>
  <link rel="preload" href="http://codein.github.io/css/tweaks.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://codein.github.io/css/tweaks.css"></noscript>
  <link rel="preload" href="http://codein.github.io/css/resume-override.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://codein.github.io/css/resume-override.css"></noscript>
  <meta name="generator" content="Hugo 0.69.2" />
  
   
  
</head>
<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
  <a class="navbar-brand js-scroll-trigger" href="#page-top">
    <span class="d-block d-lg-none">Robin Varghese</span>
    <span class="d-none d-lg-block">
      <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="/img/profilePic.png" alt="">
    </span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#about">About</a>
      </li>
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#skills">Skills</a>
          </li>
      
      
      
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#experience">Experience</a>
          </li>
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#education">Education</a>
          </li>
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#blog">Blog</a>
          </li>
      
    </ul>
  </div>
</nav>

  <div class="container-fluid p-0">
    
<nav aria-label="breadcrumb">
  <ol  class="breadcrumb">
    





<li class="breadcrumb-item">
  <a href="http://codein.github.io/">Home</a>
</li>


<li class="breadcrumb-item">
  <a href="http://codein.github.io/blog/">Blogs</a>
</li>


<li class="breadcrumb-item active">
  <a href="http://codein.github.io/blog/why-multi-process/">Single-threaded vs Multi-threading vs Multi-processing in Python</a>
</li>

  </ol>
</nav>




<section class="resume-section p-3 p-lg-5 d-flex d-column">
  <div class="my-auto">
    <h2 class="mb-0"><span class="text-primary">Single-threaded vs Multi-threading vs Multi-processing in Python</span></h2>
    <span class="text-primary">December 15, 2020</span>
    <h1 id="single-threaded-vs-multi-threading-vs-multi-processing-in-python">Single-threaded vs Multi-threading vs Multi-processing in Python</h1>
<ul>
<li><a href="/jupyter_notebooks/why-multi-process.html">jupyter notebook link</a></li>
</ul>
<p>We will try to run a few simulated processes to understand the performance difference between Single-threaded, Multi-threading and Multi-processing in Python.</p>
<p>We will learn about GIL - Alternative Python interpreters - by counting to 255 million and downloading few webpages</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">import</span> concurrent.futures
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> threading
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> math
<span style="color:#f92672">import</span> random
<span style="color:#f92672">from</span> multiprocessing <span style="color:#f92672">import</span> Pool

<span style="color:#75715e"># Reference and Credits</span>
<span style="color:#75715e"># https://realpython.com/python-concurrency</span>

thread_local <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>local()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session</span>():
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> hasattr(thread_local, <span style="color:#e6db74">&#34;session&#34;</span>):
        thread_local<span style="color:#f92672">.</span>session <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
    <span style="color:#66d9ef">return</span> thread_local<span style="color:#f92672">.</span>session


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_site</span>(url):
    <span style="color:#e6db74">&#34;&#34;&#34;Function to simulate a high IO operation&#34;&#34;&#34;</span>
    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
    session <span style="color:#f92672">=</span> get_session()
    log <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">with</span> session<span style="color:#f92672">.</span>get(url) <span style="color:#66d9ef">as</span> response:
        log <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#34;Read {len(response.content)} from {url}&#34;</span>
    duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
    <span style="color:#66d9ef">return</span> {
        <span style="color:#e6db74">&#39;work_start_time&#39;</span>: start_time,
        <span style="color:#e6db74">&#39;work_duration&#39;</span>: duration,
        <span style="color:#e6db74">&#39;work_output&#39;</span>: log,
        <span style="color:#e6db74">&#39;work_type&#39;</span>: <span style="color:#e6db74">&#39;IO&#39;</span>,

    }

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown</span>(n):
    <span style="color:#e6db74">&#34;&#34;&#34;Function to simulate a CPU-bound operation&#34;&#34;&#34;</span>
    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
    <span style="color:#66d9ef">while</span> n<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>:
        n <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
    duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
    <span style="color:#66d9ef">return</span> {
        <span style="color:#e6db74">&#39;work_start_time&#39;</span>: start_time,
        <span style="color:#e6db74">&#39;work_duration&#39;</span>: duration,
        <span style="color:#e6db74">&#39;work_output&#39;</span>: n,
        <span style="color:#e6db74">&#39;work_type&#39;</span>: <span style="color:#e6db74">&#39;CPU&#39;</span>,
    }


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_all_sites_threaded</span>(sites):
    <span style="color:#66d9ef">with</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>) <span style="color:#66d9ef">as</span> executor:
        <span style="color:#66d9ef">return</span> executor<span style="color:#f92672">.</span>map(download_site, sites)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_work</span>(args):
    (work_func, work_item) <span style="color:#f92672">=</span> args
    <span style="color:#66d9ef">return</span> work_func(work_item)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_with_thread_pool_executor</span>(work_load, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>):
    <span style="color:#66d9ef">with</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>max_workers) <span style="color:#66d9ef">as</span> executor:
        result_list <span style="color:#f92672">=</span> list(executor<span style="color:#f92672">.</span>map(process_work, work_load))
    <span style="color:#66d9ef">return</span> result_list


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_with_multiprocessing_pool</span>(work_load, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>):
    <span style="color:#66d9ef">with</span> Pool(max_workers) <span style="color:#66d9ef">as</span> executor:
        result_list <span style="color:#f92672">=</span> list(executor<span style="color:#f92672">.</span>map(process_work, work_load))
    <span style="color:#66d9ef">return</span> result_list

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_runtime</span>(work_load, multithreading<span style="color:#f92672">=</span>False, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
    <span style="color:#66d9ef">if</span> multithreading:
        results <span style="color:#f92672">=</span> process_with_thread_pool_executor(work_load, max_workers<span style="color:#f92672">=</span>max_workers)
    <span style="color:#66d9ef">if</span> multiprocessing:
        results <span style="color:#f92672">=</span> process_with_multiprocessing_pool(work_load, max_workers<span style="color:#f92672">=</span>max_workers)
    duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
    <span style="color:#66d9ef">return</span> {
        <span style="color:#e6db74">&#39;work_load_size&#39;</span>: len(work_load),
        <span style="color:#e6db74">&#39;process_start_time&#39;</span>: start_time,
        <span style="color:#e6db74">&#39;process_duration&#39;</span>: duration,
        <span style="color:#e6db74">&#39;results&#39;</span>: results
    }

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_cpu_work_load</span>(load_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
    <span style="color:#66d9ef">return</span> [(countdown, <span style="color:#ae81ff">850000</span>) <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(load_size)]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_io_work_load</span>(load_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    A work is defined as tuple with the function and arg pair.
</span><span style="color:#e6db74">    This function returns a work_load of requested load_size
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    seed_sites <span style="color:#f92672">=</span> [
        <span style="color:#e6db74">&#34;https://www.jython.org&#34;</span>,
        <span style="color:#e6db74">&#34;http://olympus.realpython.org/dice&#34;</span>,
    ]

    arg_sites <span style="color:#f92672">=</span> seed_sites <span style="color:#f92672">*</span> math<span style="color:#f92672">.</span>ceil(load_size<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)
    arg_sites <span style="color:#f92672">=</span> arg_sites[<span style="color:#ae81ff">0</span>:load_size]
    work_load <span style="color:#f92672">=</span> [(download_site, site) <span style="color:#66d9ef">for</span> site <span style="color:#f92672">in</span> arg_sites]
    <span style="color:#66d9ef">return</span> work_load

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_simulated_work_load</span>():
    runtimes <span style="color:#f92672">=</span> []
    load_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Load Size:{0}&#39;</span><span style="color:#f92672">.</span>format(load_size))
    io_work_load <span style="color:#f92672">=</span> get_io_work_load(load_size<span style="color:#f92672">=</span>load_size)
    cpu_work_load <span style="color:#f92672">=</span> get_cpu_work_load(load_size<span style="color:#f92672">=</span>load_size)
    io_and_cpu_work_load <span style="color:#f92672">=</span> io_work_load<span style="color:#f92672">+</span>cpu_work_load
    random<span style="color:#f92672">.</span>shuffle(io_and_cpu_work_load)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;io_work_load single thread&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(io_work_load, multithreading<span style="color:#f92672">=</span>True, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;io_work_load 5 threads&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(io_work_load, multithreading<span style="color:#f92672">=</span>True, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;io_work_load 5 process&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(io_work_load, multithreading<span style="color:#f92672">=</span>False, multiprocessing<span style="color:#f92672">=</span>True, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cpu_work_load single thread&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(cpu_work_load, multithreading<span style="color:#f92672">=</span>True, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cpu_work_load 5 threads&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(cpu_work_load, multithreading<span style="color:#f92672">=</span>True, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cpu_work_load 5 process&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(cpu_work_load, multithreading<span style="color:#f92672">=</span>False, multiprocessing<span style="color:#f92672">=</span>True, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;io_and_cpu_work_load single thread&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(io_and_cpu_work_load, multithreading<span style="color:#f92672">=</span>True, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)


    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;io_and_cpu_work_load 5 threads&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(io_and_cpu_work_load, multithreading<span style="color:#f92672">=</span>True, multiprocessing<span style="color:#f92672">=</span>False, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    work_load_label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;io_and_cpu_work_load 5 process&#39;</span>
    runtime <span style="color:#f92672">=</span> get_runtime(io_and_cpu_work_load, multithreading<span style="color:#f92672">=</span>False, multiprocessing<span style="color:#f92672">=</span>True, max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
    runtime[<span style="color:#e6db74">&#39;work_load_label&#39;</span>] <span style="color:#f92672">=</span> work_load_label
    <span style="color:#66d9ef">print</span>(work_load_label)
    runtimes<span style="color:#f92672">.</span>append(runtime)

    <span style="color:#66d9ef">return</span> runtimes

</code></pre></div>
    
    <ul class="tags">
    
      <li><a class="tag" href="/tags/gil">GIL</a></li>
    
      <li><a class="tag" href="/tags/multiprocessing">multiprocessing</a></li>
    
      <li><a class="tag" href="/tags/threading">threading</a></li>
    
      <li><a class="tag" href="/tags/simulation">simulation</a></li>
    
</ul>

  </div>
</section>


    <span style="color: #999999; font-size: 60%;">Build with <a href="https://codepen.io/wbeeftink/pen/dIaDH">Hugo</a> and other OSS</span>
    
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
  
  <script async src="/js/resume.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-51356721-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-51356721-1');
  </script>
  

  
</body>
</html>
